package com.ing.datadist.api.service; import com.ing.datadist.api.model.*; import com.ing.datadist.api.repository.AccountingDAO; import com.ing.datadist.batch.repository.MappingDAO; import com.ing.datadist.configreader.CofaceOpsConfigReader; import com.ing.datadist.domain.OrganisationUnitDomainWrapper; import com.ing.datadist.kafka.util.EventTransactionType; import com.ing.datadist.kafka.util.NotificationStatus; import com.twitter.finagle.http.Response; import lombok.extern.slf4j.Slf4j; import org.springframework.stereotype.Service; import java.time.Instant; import java.time.ZonedDateTime; import java.time.format.DateTimeFormatter; import java.time.temporal.ChronoUnit; import java.util.*; import java.util.concurrent.CompletableFuture; import java.util.concurrent.ExecutionException; import static com.ing.datadist.api.utils.DataDistributionConstants.*; @Service @Slf4j public class OrganisationUnitService { private final OnePamRepository onePamRepository; private final CofaceOpsConfigReader configReader; private final AddressService addressService; private final DigitalAddrService digitalAddrService; private final AccountingDAO accountingDAO; private final MappingDAO mappingDAO; Instant effectiveDateSet = Instant.now() .minusSeconds(120) // safety margin .truncatedTo(ChronoUnit.SECONDS); Instant endDateSet = effectiveDateSet.plus(3652, ChronoUnit.DAYS); private static final DateTimeFormatter FORMATTER = DateTimeFormatter.ofPattern("dd-MM-yyyy"); public OrganisationUnitService(OnePamRepository onePamRepository, CofaceOpsConfigReader configReader, AddressService addressService, DigitalAddrService digitalAddrService, AccountingDAO accountingDAO, MappingDAO mappingDAO) { this.onePamRepository = onePamRepository; this.configReader = configReader; this.addressService = addressService; this.digitalAddrService = digitalAddrService; this.accountingDAO = accountingDAO; this.mappingDAO = mappingDAO; } public void processOrganisationUnit(String orgNumber) { CreatePostalAddressRequest postalRequest = new CreatePostalAddressRequest(); CreateDigitalAddressV5Request digitalRequest = new CreateDigitalAddressV5Request("", "", "", ""); UpdateExternalIdentifierOrganisationUnitRequest externalIdRequest = new UpdateExternalIdentifierOrganisationUnitRequest(); CreateOrganisationUnitRequest orgUnitRequest = new CreateOrganisationUnitRequest(); processOrganisationUnit(orgNumber, postalRequest, digitalRequest, externalIdRequest, orgUnitRequest); } public void processOrganisationUnit(String orgNumber, CreatePostalAddressRequest postalRequest, CreateDigitalAddressV5Request digitalRequest, UpdateExternalIdentifierOrganisationUnitRequest externalIdRequest, CreateOrganisationUnitRequest orgUnitRequest) { // 1. Fetch config from DD_COFACEOPS_TBL Map<String, String> config = getConfig(orgNumber); // 2. Build wrapper from config OrganisationUnitDomainWrapper wrapper = new OrganisationUnitDomainWrapper(); wrapper.setOpsUUID(UUID.randomUUID().toString()); // or use OPS_UUID from config if available wrapper.setOrgExternalIdentifierVal(config.get("ORG_NUMBER")); wrapper.setOrganisationUnitName(decodeHtml(config.get("OPS_ORGANISATIONUNITNAME"))); wrapper.setPostalAddressStreetNm(config.get("ADR_POSTALADDRESS_STREETNM")); wrapper.setPostalAddressHouseNum(config.get("ADR_POSTALADDRESS_HOUSENUM")); wrapper.setPostalAddressHouseAdd(config.get("ADR_POSTALADDRESS_HOUSEADD")); wrapper.setPostalAddressPostalCd(config.get("ADR_POSTALADDRESS_POSTALCD")); wrapper.setPostalAddressCityName(config.get("ADR_POSTALADDRESS_CITYNAME")); wrapper.setPostalAddressCntryCd(normalizeCountryCode(config.get("ADR_POSTALADDRESS_CNTRYCD"))); wrapper.setOpsExtIdDateOfIssue(config.get("OPS_EXTID_DATEOFISSUE")); wrapper.setOpsExtIdExpiryDate(config.get("OPS_EXTID_EXPIRYDATE")); wrapper.setDigitalAddrEmail(config.get("ADR_DIGITALADDR_EMAIL")); // 3. Insert full record immediately with all fields accountingDAO.insertFullOrganisationUnitWithWrapperMergeSqlServer(wrapper); // 4. Proceed with OnePam API call CreateInvolvedPartyResponseV5 response = createOrganisationUnit(orgNumber); // Extract UUID from OnePam response String uuid = ""; InvolvedPartiesOrganisationUnitResponse getOrganisationUnit = response.getOrganisationUnit(); List<InternalIdentifierResponse> involvedPartyInternalIdentifiers = getOrganisationUnit.getInvolvedPartyInternalIdentifiers(); for (InternalIdentifierResponse internalIdentifierResponse : involvedPartyInternalIdentifiers) { uuid = internalIdentifierResponse.getInvolvedPartyInternalIdentifierValue(); } log.info("Involved Party Internal Identifiers : {}", uuid); if (uuid == null || uuid.isBlank()) { log.warn("No involvedPartyIdentifier found in response. Skipping OU flow."); return; } // Build update request for external identifier UpdateExternalIdentifierOrganisationUnitRequest updateRequest = buildUpdateRequest(orgNumber); String finalUuid = uuid; log.info("final uuid: {}", finalUuid); // Async update for external identifier CompletableFuture<Void> updateExternalIdentifierAsync = CompletableFuture.runAsync(() -> { try { accountingDAO.updateExternalIdentifier(finalUuid, updateRequest.getInvolvedPartyExternalIdentifierValue()); mappingDAO.insertEventTrack(orgNumber, "OrganisationUpdateExternalIdentifierAPI", EventTransactionType.CREATE_ORG_UNIT.getLabel(), NotificationStatus.PENDING.name()); Response responseUpdateExternalIdentifier = onePamRepository.updateExternalIdentifier(finalUuid, updateRequest).get(); if (responseUpdateExternalIdentifier.statusCode() >= 200 && responseUpdateExternalIdentifier.statusCode() < 300) { mappingDAO.insertEventTrack(orgNumber, "OrganisationUpdateExternalIdentifierAPI", EventTransactionType.CREATE_ORG_UNIT.getLabel(), NotificationStatus.RECEIVED.name()); if (mappingDAO.findPendingNotifications(orgNumber).isEmpty()) { mappingDAO.insertFinalStatus(orgNumber, "SUCCESS"); log.info("FINAL STATUS INSERTED for {}", finalUuid); } } else { log.error("Failed to update external identifier for external identifier: {}", orgNumber); } } catch (Exception e) { log.error("External ID update failed for UUID={} : {}", finalUuid, e.getMessage(), e); } }); // Async update for postal address String finalUuid1 = uuid; CompletableFuture<Void> createPostalAddressAsync = CompletableFuture.runAsync(() -> { try { accountingDAO.updatePostalAddress(finalUuid1, postalRequest.getStreetName(), postalRequest.getHouseNumber(), postalRequest.getHouseNumberAddition(), postalRequest.getPostalCode(), postalRequest.getCityName(), postalRequest.getCountryCode()); mappingDAO.insertEventTrack(orgNumber, "OrganisationUnitPostalAddressAPI", EventTransactionType.CREATE_ORG_UNIT_POSTAL_ADDRESS.getLabel(), NotificationStatus.PENDING.name()); PostalAddressResponse addr = addressService.createPostalAddress(finalUuid1); if (addr != null) { accountingDAO.updatePostalAddress(finalUuid1, addr.getStreetName(), addr.getHouseNumber(), addr.getHouseNumberAddition(), addr.getPostalCode(), addr.getCityName(), addr.getCountryCode()); log.info("Postal address created for UUID={}", finalUuid1); mappingDAO.insertEventTrack(orgNumber, "OrganisationUnitPostalAddressAPI", EventTransactionType.CREATE_ORG_UNIT_POSTAL_ADDRESS.getLabel(), NotificationStatus.RECEIVED.name()); if (mappingDAO.findPendingNotifications(orgNumber).isEmpty()) { mappingDAO.insertFinalStatus(orgNumber, "SUCCESS"); log.info("FINAL STATUS INSERTED for {}", orgNumber); } } else { log.warn("Postal address response was null for UUID={}", finalUuid1); } } catch (Exception e) { log.error("Postal address create failed for UUID={} : {}", finalUuid1, e.getMessage(), e); } }); } private CreateInvolvedPartyResponseV5 createOrganisationUnit(String uuid) { String organisationUnitName = String.valueOf(configReader.fetchOrganisationUnitName(uuid)); Map<String, String> config = getConfig(uuid); CreateInvolvedPartyRequestV5 request = CreateInvolvedPartyRequestV5.builder() .organisationUnit( CreateOrganisationUnitRequest.builder() .dataSource(DATA_SOURCE) .logicalDataDomain(LOGICAL_DATA_DOMAIN) .countryOfResidence(config.get("countryOfResidence")) .preferredLanguage(LANGUAGE) .channelOfEntry(CHANNEL_OF_ENTRY) .organisationUnitStructureType(STRUCTURE_TYPE) .effectiveDate(config.get("dateOfIssue")) .organisationUnitNames(Collections.singletonList( CreateOrganisationUnitNameRequest.builder() .organisationUnitNameType(ORGANISATION_UNIT_NAME_TYPE) .organisationUnitName(organisationUnitName) .build())) .build()) .build(); try { //          accountingDAO.createOuAccountingTableEntry(uuid,organisationUnitName); mappingDAO.insertEventTrack(uuid, "CreateOrganisationUnitApi", EventTransactionType.CREATE_ORG_UNIT.getLabel(), NotificationStatus.PENDING.name()); CreateInvolvedPartyResponseV5 responseV5 = onePamRepository.createInvolvedParty(request).get(); mappingDAO.insertEventTrack(uuid, "CreateOrganisationUnitApi", EventTransactionType.CREATE_ORG_UNIT.getLabel(), NotificationStatus.RECEIVED.name()); if( mappingDAO.findPendingNotifications(uuid).isEmpty()) { mappingDAO.insertFinalStatus(uuid, "SUCCESS"); log.info(" FINAL STATUS INSERTED for {}", uuid); } return responseV5; } catch (Exception e) { log.error("Failed to create organisation unit for uuid={}: {}", uuid, e.getMessage(), e); throw new RuntimeException(e); } } private UpdateExternalIdentifierOrganisationUnitRequest buildUpdateRequest(String uuid) { Map<String, String> config = getConfig(uuid); return UpdateExternalIdentifierOrganisationUnitRequest.builder() .involvedPartyExternalIdentifierType(EXTERNAL_ID_TYPE) .involvedPartyExternalIdentifierValue(config.getOrDefault("ORG_NUMBER", uuid)) .countryOfIssue(config.get("countryOfResidence")) .placeOfIssue(PLACE_OF_ISSUE) .dateOfIssue(config.get("dateOfIssue")) .expiryDate(config.get("expiryDate")) .dataSource(DATA_SOURCE) .effectiveDate(effectiveDateSet.toString()) .endDate(endDateSet.toString()) .build(); } private Response createOrganisationUnitHierarchy(String childId, String parentId) { OrganisationUnitOrganisationRelationshipRequest request = OrganisationUnitOrganisationRelationshipRequest.builder() .childOrganisationUnitIdentifier(childId) .parentOrganisationIdentifier(parentId) .parentRoleReasonType(ROLE_REASON_TYPE) .dataSource(DATA_SOURCE) .build(); try { Response response = onePamRepository.createOrganisationUnitHierarchy(request).get(); log.info("Successfully created hierarchy between child: {} and parent: {}", childId, parentId); return response; } catch (Exception e) { log.error("Failed to create organisation unit hierarchy", e); throw new RuntimeException("Hierarchy creation failed", e); } } private Map<String, String> getConfig(String uuid) { try{ List<Map<String, String>> list = configReader.fetchByOrgNumber(uuid); return list.isEmpty() ? Collections.emptyMap() : list.get(0); } catch (Exception e){ e.printStackTrace(); throw e; } } private String decodeHtml(String s) { return (s == null) ? null : s.replace("&amp;", "&").trim(); } private String normalizeCountryCode(String s) { if (s == null || s.isBlank()) return null; return "000".equals(s.trim()) ? "BE" : s.trim().toUpperCase(); } } package com.ing.datadist.api.model; import com.fasterxml.jackson.annotation.JsonProperty; import lombok.Builder; import lombok.Data; import lombok.*; @Data @NoArgsConstructor @AllArgsConstructor @Builder @Generated public class CreatePostalAddressRequest { @JsonProperty("postalAddressUsageType") private String postalAddressUsageType; @JsonProperty("countryCode") private String countryCode ; @JsonProperty("cityName") private String cityName; @JsonProperty("streetName") private String streetName; @JsonProperty("houseNumber") private String houseNumber; @JsonProperty("houseNumberAddition") private String houseNumberAddition; @JsonProperty("postalCode") private String postalCode; @JsonProperty("dataSource") private String dataSource; @JsonProperty("effectiveDate") private String effectiveDate; @JsonProperty("endDate") private String endDate; } package com.ing.datadist.domain; import lombok.Data; @Data public class OrganisationUnitDomainWrapper { private String opsUUID; private String orgUUID; private String orgExternalIdentifierVal; private String opsExternalIdentifierVal; private String organisationUnitName; private String postalAddressStreetNm; private String postalAddressHouseNum; private String postalAddressHouseAdd; private String postalAddressPostalCd; private String postalAddressCityName; private String postalAddressCntryCd; private String opsExtIdDateOfIssue; private String opsExtIdExpiryDate; private String digitalAddrFullTel; private String digitalAddrFullTefgn; private String digitalAddrEmail; } package com.ing.datadist.api.service; import com.ing.datadist.api.model.CreatePostalAddressRequest; import com.ing.datadist.api.model.PostalAddressResponse; import com.ing.datadist.api.model.UpdatePostalAddressV5Request; import com.ing.datadist.api.service.OnePamRepository; import com.ing.datadist.api.utils.DataDistributionConstants; import com.ing.datadist.batch.repository.MappingDAO; import com.ing.datadist.configreader.CofaceOpsConfigReader; import com.ing.datadist.kafka.util.EventTransactionType; import com.ing.datadist.kafka.util.NotificationStatus; import lombok.extern.slf4j.Slf4j; import org.springframework.stereotype.Service; import com.ing.datadist.api.utils.DataDistributionConstants.*; import java.time.LocalDate; import java.util.Collections; import java.util.HashMap; import java.util.Map; import java.util.concurrent.ExecutionException; @Service @Slf4j public class AddressService { private final OnePamRepository onePamRepository; private final MappingDAO mappingDAO; private final CofaceOpsConfigReader configReader; public AddressService(OnePamRepository onePamRepository, MappingDAO mappingDAO, CofaceOpsConfigReader configReader) { this.onePamRepository = onePamRepository; this.mappingDAO = mappingDAO; this.configReader = configReader; } public PostalAddressResponse createPostalAddress(String uuid) { log.info("Starting postal address creation for uuid={}", uuid); CreatePostalAddressRequest request = buildCreateRequest(uuid); try { mappingDAO.insertEventTrack( uuid, "CreatePostalAddressApi", EventTransactionType.CREATE_ORG_UNIT_POSTAL_ADDRESS.getLabel(), NotificationStatus.PENDING.name() ); onePamRepository.createPostalAddress(uuid, request).get(); mappingDAO.insertEventTrack( uuid, "CreatePostalAddressApi", EventTransactionType.CREATE_ORG_UNIT_POSTAL_ADDRESS.getLabel(), NotificationStatus.RECEIVED.name() ); if (mappingDAO.findPendingNotifications(uuid).isEmpty()) { mappingDAO.insertFinalStatus(uuid, "SUCCESS"); log.info("FINAL STATUS INSERTED for {}", uuid); } log.info("Successfully created postal address for uuid={}", uuid); return PostalAddressResponse.builder() .streetName(request.getStreetName()) .postalAddressUsageType(defaultIfBlank(request.getPostalAddressUsageType(), "BSN_ADR")) .houseNumber(request.getHouseNumber()) .houseNumberAddition(request.getHouseNumberAddition()) .postalCode(request.getPostalCode()) .cityName(request.getCityName()) .countryCode(defaultIfBlank(request.getCountryCode(), "BE")) .build(); } catch (InterruptedException e) { Thread.currentThread().interrupt(); // restore interrupt flag log.error("Thread interrupted while creating postal address for uuid={}", uuid, e); throw new RuntimeException("Postal address creation interrupted", e); } catch (ExecutionException e) { log.error("Execution failed while creating postal address for uuid={}", uuid, e); throw new RuntimeException("Postal address creation failed", e); } catch (Exception e) { log.error("Unexpected error creating postal address for uuid={}: {}", uuid, e.getMessage(), e); throw new RuntimeException("Postal address creation failed", e); } } private CreatePostalAddressRequest buildCreateRequest(String uuid) { Map<String, String> cfg = getConfig(uuid); return CreatePostalAddressRequest.builder() .dataSource(DataDistributionConstants.DATA_SOURCE) .countryCode(defaultIfBlank(cfg.get("countryCode"), "BE")) .postalAddressUsageType(defaultIfBlank(cfg.get("postalAddressUsageType"), "BSN_ADR")) .streetName(cfg.get("streetName")) .houseNumber(cfg.get("houseNumber")) .houseNumberAddition(cfg.get("houseNumberAddition")) .postalCode(cfg.get("postalCode")) .cityName(cfg.get("cityName")) .effectiveDate(cfg.get("effectiveDate")) .endDate(cfg.get("endDate")) .build(); } private Map<String, String> getConfig(String uuid) { try { Map<String, String> configRead = configReader.fetchAddressDetails(uuid); return (configRead == null) ? Collections.emptyMap() : configRead; } catch (Exception e) { log.warn("Failed to load postal address config for uuid={}. Falling back to defaults. Cause: {}", uuid, e.getMessage()); return Collections.emptyMap(); } } private String defaultIfBlank(String value, String fallback) { return (value == null || value.isBlank()) ? fallback : value; } public void updateLastVerificationDate(String uuid, String usageType) { String nowIso = java.time.ZonedDateTime.now(java.time.ZoneOffset.UTC) .format(java.time.format.DateTimeFormatter.ISO_OFFSET_DATE_TIME); UpdatePostalAddressV5Request request = new UpdatePostalAddressV5Request(); request.setLastVerificationDate(nowIso); String endpoint = String.format("/v5/involved-parties/%s/postal-addresses/%s", uuid, usageType); try { onePamRepository.updatePostalAddress(request, uuid, "BSN_ADR"); log.info("PATCH successful for uuid={} usageType={} verificationDate={}", uuid, usageType); } catch (Exception e) { log.error("PATCH failed for uuid={} usageType={} error={}", uuid, usageType, e.getMessage(), e); throw new RuntimeException("Failed to update verification date", e); } } } package com.ing.datadist.api.repository; import com.ing.datadist.api.model.CreateInvolvedPartyResponseV5; import com.ing.datadist.api.model.InvolvedPartiesOrganisationUnitResponse; import com.ing.datadist.domain.OrganisationUnitDomainWrapper; import lombok.extern.slf4j.Slf4j; import org.springframework.jdbc.core.JdbcTemplate; import org.springframework.stereotype.Repository; import java.sql.Timestamp; import java.time.Instant; import java.time.LocalDate; @Repository @Slf4j public class AccountingDAO { private final JdbcTemplate jdbcTemplate; public AccountingDAO(JdbcTemplate jdbcTemplate) { this.jdbcTemplate = jdbcTemplate; } public void updateExternalIdentifier(String uuid, String externalId) { String sql = "UPDATE DD_ACCOUNT_TBL SET ORG_NUMBER = ?, UPDATED_TIME = ? WHERE DD_UUID = ?"; jdbcTemplate.update(sql, externalId, Timestamp.from(Instant.now()), uuid); log.info("Updated external ID for UUID={}", uuid); } public void updateOrganisationUnitName(String uuid, String organisationUnitName) { String sql = "UPDATE DD_ACCOUNT_TBL SET FIRST_NAME = ? WHERE DD_UUID = ?"; jdbcTemplate.update(sql, organisationUnitName, uuid); log.info(" Organisation unit name updated for UUID={}", uuid); } public void updatePostalAddress(String uuid, String street, String houseNumber, String houseNumberAddition, String postalCode, String locality, String countryCode) { String sql = "UPDATE DD_ACCOUNT_TBL SET ADDR_STREET_NAME = ?, ADDR_HOUSE_NUMBER = ?, ADDR_BOX_NUMBER = ?, ADDR_POSTAL_CODE = ?, ADDR_LOCALITY_NAME = ?, ADDR_COUNTRY_CODE = ?, UPDATED_TIME = ? WHERE DD_UUID = ?"; jdbcTemplate.update(sql, street, houseNumber, houseNumberAddition, postalCode, locality, countryCode, Timestamp.from(Instant.now()), uuid); log.info("Postal Address updated for UUID={}", uuid); } public void updateDigitalAddress(String uuid, String digitalAddress) { String sql = "UPDATE DD_ACCOUNT_TBL SET DIGITAL_ADDRESS = ?, UPDATED_TIME = ? WHERE DD_UUID = ?"; jdbcTemplate.update(sql, digitalAddress, Timestamp.from(Instant.now()), uuid); log.info("Digital Address updated for UUID={}", uuid); } public void createOuAccountingTableEntry(String ddUuid, String OuName) { String eventId = "null"; String sql = "INSERT INTO DD_ACCOUNT_TBL(DD_UUID,FIRST_NAME, EVENT_ID) VALUES (?,?,?)"; jdbcTemplate.update(sql, ddUuid, OuName, eventId); log.info("Created ou account table entry for UUID={}", ddUuid); } public void insertFullOrganisationUnit(CreateInvolvedPartyResponseV5 response) { InvolvedPartiesOrganisationUnitResponse orgUnit = response.getOrganisationUnit(); String ddUuid = orgUnit.getInvolvedPartyInternalIdentifiers().get(0).getInvolvedPartyInternalIdentifierValue(); String eventId = "null"; String typeOfEntity = "ORG_UNIT"; String orgName = orgUnit.getOrganisationUnitNames().get(0).getOrganisationUnitName(); Timestamp updatedTime = Timestamp.from(Instant.now()); String sql = "INSERT INTO DD_ACCOUNT_TBL (DD_UUID, EVENT_ID, TYP_OF_ENTY, FIRST_NAME, UPDATED_TIME) VALUES (?, ?, ?, ?, ?)"; jdbcTemplate.update(sql, ddUuid, eventId, typeOfEntity, orgName, updatedTime); log.info("Inserted organisation unit record: UUID={}, EVENT_ID={}, ORG_NAME={}", ddUuid, eventId, orgName); } public void updatePostalAddressVerificationDate(String uuid, LocalDate verificationDate) { String sql = "UPDATE DD_ACCOUNT_TBL SET ADDR_LAST_VERIFICATION_DATE=?, UPDATED_TIME=? WHERE DD_UUID=?"; jdbcTemplate.update(sql, verificationDate, Timestamp.from(Instant.now()), uuid); log.info("Postal address verification date updated for UUID={}", uuid); } public void insertFullOrganisationUnitWithWrapperMergeSqlServer(OrganisationUnitDomainWrapper wrapper) { String ddUuid = wrapper.getOpsUUID(); String eventId = "null"; String typeOfEntity = "ORG_UNIT"; String orgName = wrapper.getOrganisationUnitName(); String streetName = wrapper.getPostalAddressStreetNm(); String houseNumber = wrapper.getPostalAddressHouseNum(); String boxNumber = wrapper.getPostalAddressHouseAdd(); String postalCode = wrapper.getPostalAddressPostalCd(); String locality   = wrapper.getPostalAddressCityName(); String countryCode = wrapper.getPostalAddressCntryCd(); String orgNumber = wrapper.getOrgExternalIdentifierVal(); String digitalAddress = wrapper.getDigitalAddrEmail(); Timestamp updatedTime = Timestamp.from(Instant.now()); String sql = """ MERGE INTO DD_ACCOUNT_TBL tgt USING ( SELECT ? AS DD_UUID, ? AS EVENT_ID, ? AS TYP_OF_ENTY, ? AS FIRST_NAME, ? AS ADDR_STREET_NAME, ? AS ADDR_HOUSE_NUMBER, ? AS ADDR_BOX_NUMBER, ? AS ADDR_POSTAL_CODE, ? AS ADDR_LOCALITY_NAME, ? AS ADDR_COUNTRY_CODE, ? AS ORG_NUMBER, ? AS DIGITAL_ADDRESS, ? AS UPDATED_TIME FROM dual ) src ON (tgt.DD_UUID = src.DD_UUID) WHEN MATCHED THEN UPDATE SET tgt.TYP_OF_ENTY        = src.TYP_OF_ENTY, tgt.FIRST_NAME         = src.FIRST_NAME, tgt.ADDR_STREET_NAME   = src.ADDR_STREET_NAME, tgt.ADDR_HOUSE_NUMBER  = src.ADDR_HOUSE_NUMBER, tgt.ADDR_BOX_NUMBER    = src.ADDR_BOX_NUMBER, tgt.ADDR_POSTAL_CODE   = src.ADDR_POSTAL_CODE, tgt.ADDR_LOCALITY_NAME = src.ADDR_LOCALITY_NAME, tgt.ADDR_COUNTRY_CODE  = src.ADDR_COUNTRY_CODE, tgt.ORG_NUMBER         = src.ORG_NUMBER, tgt.DIGITAL_ADDRESS    = src.DIGITAL_ADDRESS, tgt.UPDATED_TIME       = src.UPDATED_TIME WHEN NOT MATCHED THEN INSERT ( DD_UUID, EVENT_ID, TYP_OF_ENTY, FIRST_NAME, ADDR_STREET_NAME, ADDR_HOUSE_NUMBER, ADDR_BOX_NUMBER, ADDR_POSTAL_CODE, ADDR_LOCALITY_NAME, ADDR_COUNTRY_CODE, ORG_NUMBER, DIGITAL_ADDRESS, UPDATED_TIME ) VALUES ( src.DD_UUID, src.EVENT_ID, src.TYP_OF_ENTY, src.FIRST_NAME, src.ADDR_STREET_NAME, src.ADDR_HOUSE_NUMBER, src.ADDR_BOX_NUMBER, src.ADDR_POSTAL_CODE, src.ADDR_LOCALITY_NAME, src.ADDR_COUNTRY_CODE, src.ORG_NUMBER, src.DIGITAL_ADDRESS, src.UPDATED_TIME ) """; jdbcTemplate.update(sql, ddUuid, eventId, typeOfEntity, orgName, streetName, houseNumber, boxNumber, postalCode, locality, countryCode, orgNumber, digitalAddress, updatedTime); log.info("Upserted organisation unit record using wrapper (SQL Server MERGE) UUID={}", ddUuid); } }
