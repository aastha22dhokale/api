package com.ing.datadist.configreader;

import com.ing.datadist.api.model.CofaceTableAddress;
import lombok.extern.slf4j.Slf4j;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;
import java.util.HashMap;
import java.util.List;
import java.util.Map;

@Repository
@Slf4j
public class CofaceOpsConfigReader {

    private static final String FETCH_BY_ORG_NUMBER_SQL =
            "SELECT OPS_ORGANISATIONUNITNAME, ORG_NUMBER, ADR_POSTALADDRESS_CNTRYCD, " +
                    "ADR_POSTALADDRESS_STREETNM, ADR_POSTALADDRESS_HOUSENUM, ADR_POSTALADDRESS_HOUSEADD, " +
                    "ADR_POSTALADDRESS_POSTALCD, ADR_POSTALADDRESS_CITYNAME, " +
                    "OPS_EXTID_DATEOFISSUE, OPS_EXTID_EXPIRYDATE, OPS_UUID, " +
                    "ADR_DIGITALADDR_EMAIL " +
                    "FROM DD_COFACEOPS_TBL WHERE ORG_NUMBER = ?";

    private final JdbcTemplate jdbcTemplate;

    @Autowired
    public CofaceOpsConfigReader(JdbcTemplate jdbcTemplate) {
        this.jdbcTemplate = jdbcTemplate;
    }

    public List<Map<String, String>> fetchByOrgNumber(String orgNumber) {
        log.debug("Demo_28_Nov_API Start of fetchByOrgNumber");
        log.debug("Fetching organisation unit config for Org Number: '{}'", orgNumber);

        List<Map<String, String>> results = jdbcTemplate.query(
                FETCH_BY_ORG_NUMBER_SQL,
                new Object[]{orgNumber},
                new OrganisationUnitRowMapper()
        );

        log.debug("Fetched {} record(s) from DD_COFACEOPS_TBL by Org Number", results.size());
        results.forEach(row -> log.debug("Row: {}", row));
        log.debug("End of fetchByOrgNumber");
        return results;
    }
    public Map<String, String> fetchAddressDetails(String uuid) {
        String sql = "SELECT ADR_POSTALADDRESS_STREETNM, ADR_POSTALADDRESS_CITYNAME, " +
                "ADR_POSTALADDRESS_POSTALCD, OPS_ORGANISATIONUNITNAME, ADR_POSTALADDRESS_CNTRYCD " +
                "FROM DD_COFACEOPS_TBL WHERE OPS_UUID = ?";
        return jdbcTemplate.queryForObject(sql, new Object[]{uuid}, (rs, rowNum) -> {
            Map<String, String> result = new HashMap<>();
            result.put("street", rs.getString("ADR_POSTALADDRESS_STREETNM"));
            result.put("city", rs.getString("ADR_POSTALADDRESS_CITYNAME"));
            result.put("postalCode", rs.getString("ADR_POSTALADDRESS_POSTALCD"));
            result.put("country", rs.getString("ADR_POSTALADDRESS_CNTRYCD"));
            return result;
        });
    }
