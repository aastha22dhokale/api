package com.ing.datadist.batch.tasklet;

import com.ing.datadist.api.model.SearchInvolvedPartiesResponseV1;
import com.ing.datadist.api.service.InvolvedPartySearchService;
import com.ing.datadist.api.service.OrganisationUnitService;
import com.ing.datadist.api.service.UpdateOrganisationUnitService;
import com.ing.datadist.domain.OrganisationUnitDomainWrapper;
import com.ing.datadist.domain.TaskletCofaceOpsDomainWrapper;
import com.ing.datadist.oil.service.OilCreateFileLogicService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.batch.core.StepContribution;
import org.springframework.batch.core.configuration.annotation.StepScope;
import org.springframework.batch.core.scope.context.ChunkContext;
import org.springframework.batch.core.step.tasklet.Tasklet;
import org.springframework.batch.repeat.RepeatStatus;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.beans.factory.annotation.Value;
import org.springframework.stereotype.Component;

import java.util.ArrayList;
import java.util.List;

@Component
@StepScope
@Slf4j
public class OnePamSearchApiTasklet implements Tasklet {

    @Value("${app.apiFlow}")
    private boolean apiFlow;

    @Autowired
    OilCreateFileLogicService oilCreateFileLogicService;

    private final InvolvedPartySearchService searchService;

    private final OrganisationUnitService organisationUnitService;

    private final UpdateOrganisationUnitService updateOrganisationUnitService;

    private final TaskletCofaceOpsDomainWrapper taskletCofaceOpsDomainWrapper;

    public OnePamSearchApiTasklet(InvolvedPartySearchService searchService, OrganisationUnitService organisationUnitService, UpdateOrganisationUnitService updateOrganisationUnitService, TaskletCofaceOpsDomainWrapper taskletCofaceOpsDomainWrapper) {
        this.searchService = searchService;
        this.organisationUnitService = organisationUnitService;
        this.updateOrganisationUnitService = updateOrganisationUnitService;
        this.taskletCofaceOpsDomainWrapper = taskletCofaceOpsDomainWrapper;
    }

    @Override
    public RepeatStatus execute(StepContribution contribution, ChunkContext chunkContext) throws Exception {
        try {
            List<OrganisationUnitDomainWrapper> wrappers = taskletCofaceOpsDomainWrapper.getCofaceOpsDomainWrapper();
            List<OrganisationUnitDomainWrapper> oilCreateWrapperList = new ArrayList<>();
            List<OrganisationUnitDomainWrapper> oilUpdateWrapperList = new ArrayList<>();
            log.info("Demo_28_Nov_API OnePamSearchApiTasklet wrappers size:{}", wrappers.size());
            log.info("Demo_28_Nov_API apiFlow:{}", apiFlow);

            for (OrganisationUnitDomainWrapper domainWrapper : wrappers) {
                try {

                    String organisationDdUuid = domainWrapper.getOrgUUID();
                    String organisationUnitDdUuid = domainWrapper.getOpsUUID();

                    if (organisationDdUuid == null || organisationDdUuid.isEmpty()) {
                        log.info("Skipping wrapper: OrgUUID is null or empty");
                        continue;
                    }

//                    SearchInvolvedPartiesResponseV1 organisationResult = searchService.searchInvolvedPartyByInternalIdentifier("organisation", "UUID", organisationDdUuid);
//                    if (organisationResult != null && organisationResult.getOrganisations() != null && organisationUnitDdUuid != null) {
//                        log.info("Organisation found for UUID: {}", organisationDdUuid);
                        SearchInvolvedPartiesResponseV1 organisationUnitResult = searchService.searchInvolvedPartyByInternalIdentifier("organisationUnit", "UUID", organisationUnitDdUuid);
                        if (organisationUnitResult == null || organisationUnitResult.getOrganisationUnits() == null || organisationUnitResult.getOrganisationUnits().isEmpty()) {
                            if (apiFlow) {
                                organisationUnitService.processOrganisationUnit(organisationUnitDdUuid);
                            } else {
                                oilCreateWrapperList.add(domainWrapper);
                            }
                        }
                else {
                            updateOrganisationUnitService.updateOrganisationUnit(domainWrapper, organisationUnitResult, apiFlow, oilUpdateWrapperList);
                        }
//                    }
                } catch (Exception e) {
                    log.error("Exception occurred while executing API call for UUID :{} error :{}", domainWrapper.getOpsUUID(), e);
                }
            }
            if(!apiFlow) {
                oilCreateFileLogicService.createOilFile(null, oilCreateWrapperList, oilUpdateWrapperList, "D");
            }
        } catch (Exception ex) {
            log.error("Exception occurred while executing OnePamSearchApiTasklet : {}", ex.getMessage());
        }
        return RepeatStatus.FINISHED;
    }
}
