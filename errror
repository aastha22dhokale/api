Expected 2 arguments but found 8package com.ing.datadist.api.service;

import com.ing.datadist.api.model.CreatePostalAddressRequest;
import com.ing.datadist.api.model.CreatePostalAddressResponse;
import com.ing.datadist.api.model.PostalAddressResponse;
import com.ing.datadist.api.repository.AccountingDAO;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

//import java.security.Timestamp;
import java.sql.Timestamp;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.concurrent.ExecutionException;


@Service

@Slf4j

public class AddressService {
//
private final OnePamRepository repository;

    private final AccountingDAO accountingDAO;

    public AddressService(OnePamRepository repository, AccountingDAO accountingDAO) {

        this.repository = repository;

        this.accountingDAO = accountingDAO;

    }

    public PostalAddressResponse createPostalAddress(String uuid, CreatePostalAddressRequest request) {

        log.info("Calling OnePAM with request: {}", request);

        // Call repository and get wrapped response

        CreatePostalAddressResponse responseWrapper = repository.createPostalAddress(uuid, request).join();

        // Extract postalAddress object

        PostalAddressResponse postalAddress = responseWrapper.getPostalAddress();

        log.info("Received postalAddress: {}", postalAddress);

        try {

            // Convert Instant to Timestamp in proper DB format

            Instant effectiveInstant = postalAddress.getEffectiveDate();

            Timestamp effectiveTimestamp = effectiveInstant != null

                    ? Timestamp.valueOf(LocalDateTime.ofInstant(effectiveInstant, ZoneId.systemDefault()))

                    : null;

            // Insert into DB

            accountingDAO.insertPostalAddress(uuid,

                    postalAddress.getStreetName(),

                    postalAddress.getHouseNumber(),

                    postalAddress.getHouseNumberAddition(),

                    postalAddress.getPostalCode(),

                    postalAddress.getCityName(),

                    postalAddress.getCountryCode(),

                    effectiveTimestamp);

            log.info("Postal address inserted successfully for UUID={}", uuid);

        } catch (Exception e) {

            log.error("Failed to insert postal address for UUID={} : {}", uuid, e.getMessage(), e);

            throw new RuntimeException(e);

        }

        return postalAddress;

    }
package com.ing.datadist.api.repository;

import com.ing.datadist.api.model.CreateInvolvedPartyResponseV5;
import com.ing.datadist.api.model.InvolvedPartiesOrganisationUnitResponse;
import com.ing.datadist.api.model.PostalAddressResponse;
import com.ing.datadist.kafka.consumer.service.PostalAddressService;
import lombok.extern.slf4j.Slf4j;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.stereotype.Repository;

import java.sql.Timestamp;
import java.time.Instant;

@Repository
@Slf4j
public class AccountingDAO {

    private final JdbcTemplate jdbcTemplate;
    private final PostalAddressService postalAddressService;

    public AccountingDAO(JdbcTemplate jdbcTemplate, PostalAddressService postalAddressService) {
        this.jdbcTemplate = jdbcTemplate;
        this.postalAddressService = postalAddressService;
    }

    public void updateExternalIdentifier(String uuid, String externalId) {
        String sql = "UPDATE DD_ACCOUNT_TBL SET ORG_NUMBER = ?, UPDATED_TIME = ? WHERE DD_UUID = ?";
        jdbcTemplate.update(sql, externalId, Timestamp.from(Instant.now()), uuid);
        log.info("Updated external ID for UUID={}", uuid);
    }


    public void updateOrganisationUnitName(String uuid, String organisationUnitName) {
        String sql = "UPDATE DD_ACCOUNT_TBL SET FIRST_NAME = ? WHERE DD_UUID = ?";
        jdbcTemplate.update(sql, organisationUnitName, uuid);
        log.info(" Organisation unit name updated for UUID={}", uuid);
    }

    public void updatePostalAddress(String uuid, String street, String houseNumber,
                                    String houseNumberAddition, String postalCode,
                                    String locality, String countryCode) {
        String sql = "UPDATE DD_ACCOUNT_TBL SET ADDR_STREET_NAME = ?, ADDR_HOUSE_NUMBER = ?, ADDR_BOX_NUMBER = ?, ADDR_POSTAL_CODE = ?, ADDR_LOCALITY_NAME = ?, ADDR_COUNTRY_CODE = ?, UPDATED_TIME = ? WHERE DD_UUID = ?";
        jdbcTemplate.update(sql, street, houseNumber, houseNumberAddition, postalCode, locality, countryCode, Timestamp.from(Instant.now()), uuid);
        log.info("Postal Address updated for UUID={}", uuid);
    }

    public void updateDigitalAddress(String uuid, String digitalAddress) {
        String sql = "UPDATE DD_ACCOUNT_TBL SET DIGITAL_ADDRESS = ?, UPDATED_TIME = ? WHERE DD_UUID = ?";
        jdbcTemplate.update(sql, digitalAddress, Timestamp.from(Instant.now()), uuid);
        log.info("Digital Address updated for UUID={}", uuid);
    }

    public void updateHierarchy(String uuid, String parentId) {
        String sql = "UPDATE DD_ACCOUNT_TBL SET PARENT_ORG_UUID = ?, UPDATED_TIME = ? WHERE DD_UUID = ?";
        jdbcTemplate.update(sql, parentId, Timestamp.from(Instant.now()), uuid);
        log.info("Hierarchy updated for UUID={}", uuid);
    }

    public void createOuAccountingTableEntry(String ddUuid,String OuName) {
        String eventId = "null";
        String sql = "INSERT INTO DD_ACCOUNT_TBL(DD_UUID,FIRST_NAME, EVENT_ID) VALUES (?,?,?)";
        jdbcTemplate.update(sql,ddUuid,OuName, eventId);
        log.info("Created ou account table entry for UUID={}", ddUuid);
    }

    public void insertFullOrganisationUnit(CreateInvolvedPartyResponseV5 response) {
        InvolvedPartiesOrganisationUnitResponse orgUnit = response.getOrganisationUnit();

        String ddUuid = orgUnit.getInvolvedPartyInternalIdentifiers().get(0).getInvolvedPartyInternalIdentifierValue();
        String eventId = "null";
        String typeOfEntity = "ORG_UNIT";
        String orgName = orgUnit.getOrganisationUnitNames().get(0).getOrganisationUnitName();
        Timestamp updatedTime = Timestamp.from(Instant.now());

        String sql = "INSERT INTO DD_ACCOUNT_TBL (DD_UUID, EVENT_ID, TYP_OF_ENTY, FIRST_NAME, UPDATED_TIME) VALUES (?, ?, ?, ?, ?)";
        jdbcTemplate.update(sql, ddUuid, eventId, typeOfEntity, orgName, updatedTime);

        log.info("Inserted organisation unit record: UUID={}, EVENT_ID={}, ORG_NAME={}", ddUuid, eventId, orgName);
    }

    public void insertPostalAddress(String uuid, PostalAddressResponse adr) {
//        String isoDate = postalAddressService.getE
        jdbcTemplate.update(

                "INSERT INTO accounting_table (" +

                        "DD_UUID, ADDR_STREET_NAME, ADDR_HOUSE_NUMBER, ADDR_BOX_NUMBER, " +

                        "ADDR_POSTAL_CODE, ADDR_COUNTRY_CODE, UPDATED_TIME" +

                        ") VALUES (?, ?, ?, ?, ?, ?, ?)",

                uuid,

                adr.getStreetName(),

                adr.getHouseNumber(),

                adr.getHouseNumberAddition(),

                adr.getPostalCode(),

                adr.getCityName(),

                adr.getCountryCode(),

//                adr.getUnstructuredAddressLine1(), // or digitalAddress if available

                adr.getEffectiveDate() != null ? Timestamp.valueOf(adr.getEffectiveDate()) : new Timestamp(System.currentTimeMillis())

        );

    }


}
