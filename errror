package com.ing.datadist.api.service;

import com.ing.datadist.api.model.CreatePostalAddressRequest;
import com.ing.datadist.api.model.CreatePostalAddressResponse;
import com.ing.datadist.api.model.PostalAddressResponse;
import com.ing.datadist.api.repository.AccountingDAO;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

//import java.security.Timestamp;
import java.sql.Timestamp;
import java.time.Instant;
import java.time.LocalDateTime;
import java.time.ZoneId;
import java.util.concurrent.ExecutionException;


@Service

@Slf4j

public class AddressService {
//
private final OnePamRepository repository;

    private final AccountingDAO accountingDAO;

    public AddressService(OnePamRepository repository, AccountingDAO accountingDAO) {

        this.repository = repository;

        this.accountingDAO = accountingDAO;

    }

    public PostalAddressResponse createPostalAddress(String uuid, CreatePostalAddressRequest request) {

        log.info("Calling OnePAM with request: {}", request);

        // Call repository and get wrapped response

        CreatePostalAddressResponse responseWrapper = repository.createPostalAddress(uuid, request).join();

        // Extract postalAddress object

        PostalAddressResponse postalAddress = responseWrapper.getPostalAddress();

        log.info("Received postalAddress: {}", postalAddress);

        try {

            // Convert Instant to Timestamp in proper DB format

            Instant effectiveInstant = postalAddress.getEffectiveDate();

            Timestamp effectiveTimestamp = effectiveInstant != null

                    ? Timestamp.valueOf(LocalDateTime.ofInstant(effectiveInstant, ZoneId.systemDefault()))

                    : null;

            // Insert into DB

            accountingDAO.insertPostalAddress(uuid,

                    postalAddress.getStreetName(),

                    postalAddress.getHouseNumber(),

                    postalAddress.getHouseNumberAddition(),

                    postalAddress.getPostalCode(),

                    postalAddress.getCityName(),

                    postalAddress.getCountryCode(),

                    effectiveTimestamp);

            log.info("Postal address inserted successfully for UUID={}", uuid);

        } catch (Exception e) {

            log.error("Failed to insert postal address for UUID={} : {}", uuid, e.getMessage(), e);

            throw new RuntimeException(e);

        }

        return postalAddress;

    }
fix
