package com.ing.datadist.api.service;

import com.ing.datadist.api.model.CreatePostalAddressRequest;
import com.ing.datadist.api.model.PostalAddressResponse;
import lombok.extern.slf4j.Slf4j;
import org.springframework.stereotype.Service;

import java.util.concurrent.ExecutionException;

@Service
@Slf4j
public class AddressService {

    private final OnePamRepository onePamRepository;

    public AddressService(OnePamRepository onePamRepository) {
        this.onePamRepository = onePamRepository;
    }

    /**
     * Creates postal address in OnePam and returns normalized response.
     * Falls back to request values if OnePam response is incomplete.
     */
    public PostalAddressResponse createPostalAddress(String uuid, CreatePostalAddressRequest request) {
        log.info("Starting postal address creation for UUID: {}", uuid);

        PostalAddressResponse responseFromPam = null;
        try {
            responseFromPam = onePamRepository.createPostalAddress(uuid, request).get();
            log.info("Successfully created postal address for UUID: {}", uuid);
        } catch (Exception e) {
            log.error("Failed to create postal address for UUID: {}", uuid, e);
            throw new RuntimeException("Postal address creation failed", e);
        }

        // Normalize response: if OnePam returns null or partial data, fallback to request values
        if (responseFromPam == null) {
            log.warn("OnePam returned null response for UUID: {}. Using fallback values.", uuid);
            return fallbackResponse(request);
        }

        return normalizeResponse(responseFromPam, request);
    }

    /**
     * Fallback if OnePam response is null.
     */
    private PostalAddressResponse fallbackResponse(CreatePostalAddressRequest req) {
        return PostalAddressResponse.builder()
                .streetName(defaultIfBlank(req.getStreetName(), ""))
                .postalAddressUsageType(defaultIfBlank(req.getPostalAddressUsageType(), "BSN_ADR"))
                .houseNumber(defaultIfBlank(req.getHouseNumber(), ""))
                .houseNumberAddition(defaultIfBlank(req.getHouseNumberAddition(), ""))
                .postalCode(defaultIfBlank(req.getPostalCode(), ""))
                .cityName(defaultIfBlank(req.getCityName(), ""))
                .countryCode(defaultIfBlank(req.getCountryCode(), "BE"))
                .build();
    }

    /**
     * Normalize OnePam response by filling missing fields from request.
     */
    private PostalAddressResponse normalizeResponse(PostalAddressResponse resp, CreatePostalAddressRequest req) {
        return PostalAddressResponse.builder()
                .streetName(defaultIfBlank(resp.getStreetName(), req.getStreetName()))
                .postalAddressUsageType(defaultIfBlank(resp.getPostalAddressUsageType(),
                        defaultIfBlank(req.getPostalAddressUsageType(), "BSN_ADR")))
                .houseNumber(defaultIfBlank(resp.getHouseNumber(), req.getHouseNumber()))
                .houseNumberAddition(defaultIfBlank(resp.getHouseNumberAddition(), req.getHouseNumberAddition()))
                .postalCode(defaultIfBlank(resp.getPostalCode(), req.getPostalCode()))
                .cityName(defaultIfBlank(resp.getCityName(), req.getCityName()))
                .countryCode(defaultIfBlank(resp.getCountryCode(),
                        defaultIfBlank(req.getCountryCode(), "BE")))
                .build();
    }

    private String defaultIfBlank(String value, String fallback) {
        return (value == null || value.isBlank()) ? fallback : value;
    }
}

package com.ing.datadist.api.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

import java.io.Serializable;


@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Generated
public class PostalAddressResponse implements Serializable {
    private static final long serialVersionUID = 1L;

    @JsonProperty("postalAddressUsageType")
    private String postalAddressUsageType;

    @JsonProperty("countryCode")
    private String countryCode;

    @JsonProperty("countryRegionCode")
    private String countryRegionCode;

    @JsonProperty("districtName")
    private String districtName;

    @JsonProperty("cityName")
    private String cityName;

    @JsonProperty("cityAreaName")
    private String cityAreaName;

    @JsonProperty("regionName")
    private String regionName;

    @JsonProperty("postalCode")
    private String postalCode;

    @JsonProperty("streetName")
    private String streetName;

    @JsonProperty("houseNumber")
    private String houseNumber;

    @JsonProperty("houseNumberAddition")
    private String houseNumberAddition;

    @JsonProperty("buildingName")
    private String buildingName;

    @JsonProperty("deliveryInformation")
    private String deliveryInformation;

    @JsonProperty("floor")
    private String floor;

    @JsonProperty("locationUnitNumber")
    private String locationUnitNumber;

    @JsonProperty("departmentName")
    private String departmentName;

    @JsonProperty("subdepartmentName")
    private String subdepartmentName;

    @JsonProperty("poBoxNumber")
    private String poBoxNumber;

    @JsonProperty("streetType")
    private String streetType;

    @JsonProperty("unstructuredAddressLine1")
    private String unstructuredAddressLine1;

    @JsonProperty("unstructuredAddressLine2")
    private String unstructuredAddressLine2;

    @JsonProperty("unstructuredAddressLine3")
    private String unstructuredAddressLine3;

    @JsonProperty("deliveryFailureReasonType")
    private String deliveryFailureReasonType;

    @JsonProperty("dataSource")
    private String dataSource;

    @JsonProperty("lastUpdateUser")
    private String lastUpdateUser;

    @JsonProperty("lastUpdateDate")
    private String lastUpdateDate;

    @JsonProperty("effectiveDate")
    private String effectiveDate;

    @JsonProperty("lastVerificationDate")
    private String lastVerificationDate;

    @JsonProperty("endDate")
    private String endDate;
}package com.ing.datadist.api.model;

import com.fasterxml.jackson.annotation.JsonProperty;
import lombok.*;

import java.io.Serializable;


@Data
@NoArgsConstructor
@AllArgsConstructor
@Builder
@Generated
public class PostalAddressResponse implements Serializable {
    private static final long serialVersionUID = 1L;

    @JsonProperty("postalAddressUsageType")
    private String postalAddressUsageType;

    @JsonProperty("countryCode")
    private String countryCode;

    @JsonProperty("countryRegionCode")
    private String countryRegionCode;

    @JsonProperty("districtName")
    private String districtName;

    @JsonProperty("cityName")
    private String cityName;

    @JsonProperty("cityAreaName")
    private String cityAreaName;

    @JsonProperty("regionName")
    private String regionName;

    @JsonProperty("postalCode")
    private String postalCode;

    @JsonProperty("streetName")
    private String streetName;

    @JsonProperty("houseNumber")
    private String houseNumber;

    @JsonProperty("houseNumberAddition")
    private String houseNumberAddition;

    @JsonProperty("buildingName")
    private String buildingName;

    @JsonProperty("deliveryInformation")
    private String deliveryInformation;

    @JsonProperty("floor")
    private String floor;

    @JsonProperty("locationUnitNumber")
    private String locationUnitNumber;

    @JsonProperty("departmentName")
    private String departmentName;

    @JsonProperty("subdepartmentName")
    private String subdepartmentName;

    @JsonProperty("poBoxNumber")
    private String poBoxNumber;

    @JsonProperty("streetType")
    private String streetType;

    @JsonProperty("unstructuredAddressLine1")
    private String unstructuredAddressLine1;

    @JsonProperty("unstructuredAddressLine2")
    private String unstructuredAddressLine2;

    @JsonProperty("unstructuredAddressLine3")
    private String unstructuredAddressLine3;

    @JsonProperty("deliveryFailureReasonType")
    private String deliveryFailureReasonType;

    @JsonProperty("dataSource")
    private String dataSource;

    @JsonProperty("lastUpdateUser")
    private String lastUpdateUser;

    @JsonProperty("lastUpdateDate")
    private String lastUpdateDate;

    @JsonProperty("effectiveDate")
    private String effectiveDate;

    @JsonProperty("lastVerificationDate")
    private String lastVerificationDate;

    @JsonProperty("endDate")
    private String endDate;
}
